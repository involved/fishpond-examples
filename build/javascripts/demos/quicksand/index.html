<!DOCTYPE html>
<!--[if lt IE 7]> <html lang="en" class="no-js ie6 old-ie"> <![endif]-->
<!--[if IE 7]>    <html lang="en" class="no-js ie7 old-ie"> <![endif]-->
<!--[if IE 8]>    <html lang="en" class="no-js ie8 old-ie"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class='no-js' lang='en'>
  <!--<![endif]-->
  <head>
    <meta charset='utf-8' />
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible' />
    <title>Fishpond</title>
    <meta content='noindex, nofollow' name='robots' />
    <meta content='' name='keywords' />
    <meta content='width=device-width, maximum-scale=1.0' name='viewport' />
    <link href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.17/themes/cupertino/jquery-ui.css" media="screen" rel="stylesheet" type="text/css" />
    <style type='text/css'>
      /*<![CDATA[*/
        body{
          padding-top: 100px;
        }
      /*]]>*/
    </style>
    <style type='text/css'>
      /*<![CDATA[*/
        h1 {
          text-align: center;
          }
        
        #results ul li .thumbnail{
          min-height: 100px;
          text-align: center;
          position: relative;
        }
        
          #results ul li .thumbnail .btn{
            position: absolute;
            bottom: 15px;
            left: 30px;
            display: block;
          }
        
        .modal-body.loading{
          background: url(/images/common/loading.gif) no-repeat center center;
          min-height: 150px;
        }
      /*]]>*/
    </style>
  </head>
  <body>
    <div class='navbar navbar-fixed-top'>
      <div class='navbar-inner'>
        <div class='container'>
          <a class='brand' href='/'>Fishpond Examples</a>
          <ul class='nav'>
            <li class='dropdown'>
              <a class='dropdown-toggle' data-toggle='dropdown' href='#'>
                Demos
                <b class='caret'></b>
              </a>
              <ul class='dropdown-menu'>
                <li><a href="/fishpond-examples/demos/atom">atom</a></li>
                <li><a href="/fishpond-examples/demos/basic-dynamic">basic-dynamic</a></li>
                <li><a href="/fishpond-examples/demos/basic-html5">basic-html5</a></li>
                <li><a href="/fishpond-examples/demos/basic-static">basic-static</a></li>
                <li><a href="/fishpond-examples/demos/dial">dial</a></li>
                <li><a href="/fishpond-examples/demos/flotr">flotr</a></li>
                <li><a href="/fishpond-examples/demos/quicksand">quicksand</a></li>
                <li><a href="/fishpond-examples/demos/scaffold">scaffold</a></li>
                <li><a href="/fishpond-examples/demos/spider-graph">spider-graph</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class='container' id='loading'>
      <div class='span4 offset4'>
        <div class='progress progress-striped active'>
          <div class='bar' style='width: 100%'></div>
        </div>
      </div>
    </div>
    <div class='container hide' id='auth'>
      <div class='span6 offset3'>
        <center>
          <form class='well form-inline'>
            <input class='input-large' id='api_key' placeholder='API key' type='text' />
            <input class='input-small' id='pond_token' placeholder='Pond Token' type='text' />
            <button class='btn btn-success' type='submit'>
              Connect
            </button>
          </form>
        </center>
      </div>
    </div>
    <div class='container hide' id='demo'>
      <div class='page-header'>
        <h1>Quicksand Demo</h1>
      </div>
      <section id='query'>
        <div class='row'>
          <div class='span5'>
            <div class='well'>
              <h2>Tags</h2>
              <form class='form-horizontal' id='fishpond'>
                <fieldset>
                </fieldset>
              </form>
              <h2>Filters</h2>
              <p>
                <em>No filters defined.</em>
              </p>
            </div>
          </div>
          <div class='span6 offset1'>
            <h2>Results</h2>
            <div id='results'>
              <ul class='thumbnails'></ul>
            </div>
          </div>
        </div>
      </section>
      <div class='modal fade hide' id='modalTemplate'>
        <div class='modal-header'>
          <button class='close' data-dismiss='modal'>×</button>
          <h3></h3>
        </div>
        <div class='modal-body loading'>
          <!-- / Empty -->
        </div>
        <div class='modal-footer'>
          <a class='btn' data-dismiss='modal' href='#'>Close</a>
        </div>
      </div>
    </div>
    <div class='container'>
      <hr />
      <footer>
        &copy; iFish 2012
      </footer>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js" type="text/javascript"></script>
    <script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-dropdown.js" type="text/javascript"></script>
    <script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-modal.js" type="text/javascript"></script>
    <script src="http://ifish-prototype.herokuapp.com/assets/api/v1/fishpond.js" type="text/javascript"></script>
    <script src="https://raw.github.com/yeco/jquery-ui-touch-punch/master/jquery.ui.touch-punch.min.js" type="text/javascript"></script>
    <script src="https://raw.github.com/razorjack/quicksand/master/jquery.quicksand.js" type="text/javascript"></script>
    <script type='text/javascript'>
      //<![CDATA[
        var setupFishpond = function(fishpond){ // you must define this function in your demo, if you want hooks to the fishpond
          var container = $("section#query");
        
          fishpond.resultsUpdated(function(results){
            //console.log(results);
        
            var source = $("#results ul", container);
            var list = $("<ul></ul>");
            var listItem;
        
            $.each(results, function(position, result){ 
              listItem = $("" +
                "<li class='span2' data-id='"+result.fish.id+"'>" +
                  "<a class='thumbnail' href='#fishInfo'>" +
                    "<strong>" + result.fish.title + "</strong><br />" + result.score + "<br />" +
                  "</a>" +
                "</li>");
        
              list.append(listItem);
            });
        
            if(source.find("li").length == 0) {
              source.append(list.find("li"));
              modalInit();
            } else {
              source.quicksand(list.find("li"), {
                // Do nothing
              }, function() {
                modalInit();
              });
            }
         });
        
          fishpond.ready(function(pond){
            $("#loading").fadeOut(0);
            $("#demo").fadeIn(400);
            $("#demo h1").append(' "' + pond.name + '"');       
        
            // Dynamically Generate Form Controls        
            var form = $("form fieldset");
            var controlGroup;
        
            $.each(pond.tag_ids, function(name, token){ 
              controlGroup = $("" +
                "<div class='control-group'>" +
                  "<label class='control-label'>" +
                    name + " <output>(10)</output>" +
                  "</label>" +
                  "<div class='controls'>" +
                    "<input id='query_tag_"+token+"' data-slug='"+name+"' name='query[tags]["+token+"]' type='hidden' value='6'>" +
                    "<div class='slider span2' data-target='query[tags]["+token+"]'></div>" +
                  "</div>" +
                "</div>");
        
              form.append(controlGroup);
            });
        
            // jQuery UI Slider
            $(".slider").slider({
              value: 10,
              min: 0,
              max: 20,
              step: 1,
              slide: function(e, ui){
                var output = $(this).parents('.control-group').find('output');
                var hiddenField = $("input[name='" + $(this).data('target') + "']");
                var value = ui['value'];
        
                if(value.toString() != hiddenField.val().toString()){
                  hiddenField.val(value);
                  output.html(output.html().split("(")[0] + "(" + value.toString() + ")");
        
                  var tags = {};
                  var filters = {};
                  $("form#fishpond input").each(function(){
                    tags[$(this).data('slug')] = $(this).val();
                  });
                  fishpond.query(tags, filters);
                }
              }
            });
        
            fishpond.query({}, {});
        
          });
        
          fishpond.loading(function(percent){
            $("#loading .progress").removeClass("progress-striped");
            $("#loading .bar").css({width: (percent * 100) + "%"});
          });
        
        
          //Functions
          function modalInit(){
            var modalGroup,
                fishModal,
                fishID;
        
            $('#results a').on('click', function(e){
              e.preventDefault();
              console.log("[Fish] Clicked");
              fishID = $(this).closest('li').attr('data-id');
              fishModal = $('#modalTemplate').clone().attr("id",fishID);
        
              fishModal.modal('show');
        
              fishpond.get_fish(fishID, function(data){
                console.log("[Fish] Metadata receieved:");
                console.log(data);
              
                modalGroup = $("" +
                  "<div class='modal-header'>" +
                    "<button class='close' data-dismiss='modal'>×</button>" +
                    "<h3>" + data.title + "</h3>" +
                  "</div>" +
                  "<div class='modal-body'>" +
                    "<div class='row'>" + 
                      "<div class='span2'>" + 
                        "<img src='http://placehold.it/100x100' alt='" + data.title + "' />" +
                      "</div>" + 
                      "<div class='span4'>" + 
                        "<p>" + data.description + "</p>" +
                        "<a href='" + data.url + "' target='_blank'>Find out more</a>" +
                      "</div>" +
                    "</div>" +
                  "</div>" +
                  "<div class='modal-footer'>" +
                    "<a href='#' class='btn' data-dismiss='modal'>Close</a>" +
                  "</div>");
        
                if (fishModal.attr("id") == data.id){
                  fishModal.html(modalGroup);
                }
              });
            });
          }
        
        };
      //]]>
    </script>
    <script type='text/javascript'>
      //<![CDATA[
        $(function(){
          // Autofill auth form
          $("#auth form").each(function(){
            var form = $(this);
            var apiKeyInput = $("#api_key", form);
            var pondTokenInput = $("#pond_token", form);
            apiKeyInput.val(localStorage.getItem("fishpond_api_key"));
            pondTokenInput.val(localStorage.getItem("fishpond_pond_token"));
           });
        
          $("#auth").fadeIn(400);
          $("#loading").fadeOut(0);
        
          // Default Authentication setup
          $("#auth form").submit(function(e){
              e.preventDefault();
              var form = $(this);
              var apiKeyInput = $("#api_key", form);
              var pondTokenInput = $("#pond_token", form);
              var apiKey = apiKeyInput.val();
              var pondToken = pondTokenInput.val();
              var errors = [];
        
              if(apiKey.length != 41){
                errors.push("API key should be 41 characters long");
              }
              if(pondToken.length != 6){
                errors.push("Pond token should be 6 characters long");
              }
        
              if(errors.length > 0){
                alert("There were errors in your authentication: " + errors.join(", "));
              } else {
                $("#auth").fadeOut(0);
                $("#loading").fadeIn(400);
                localStorage.setItem("fishpond_api_key", apiKey);
                localStorage.setItem("fishpond_pond_token", pondToken);
        
                var options = { debug: true };
                var fishpond = new Fishpond(apiKey, options);
                setupFishpond(fishpond);
                fishpond.init(pondToken);
              }
          });
        });
      //]]>
    </script>
  </body>
</html>
